'use strict';var TextLayerBuilder=function textLayerBuilder(options){var textLayerFrag=document.createDocumentFragment();this.textLayerDiv=options.textLayerDiv;this.layoutDone=false;this.divContentDone=false;this.pageIdx=options.pageIndex;this.matches=[];this.lastScrollSource=options.lastScrollSource;this.viewport=options.viewport;this.isViewerInPresentationMode=options.isViewerInPresentationMode;if(typeof PDFFindController==='undefined'){window.PDFFindController=null;}if(typeof this.lastScrollSource==='undefined'){this.lastScrollSource=null;}this.beginLayout=function textLayerBuilderBeginLayout(){this.textDivs=[];this.renderingDone=false;};this.endLayout=function textLayerBuilderEndLayout(){this.layoutDone=true;this.insertDivContent();};this.renderLayer=function textLayerBuilderRenderLayer(){var self=this;var textDivs=this.textDivs;var bidiTexts=this.textContent.bidiTexts;var textLayerDiv=this.textLayerDiv;var canvas=document.createElement('canvas');var ctx=canvas.getContext('2d');var MAX_TEXT_DIVS_TO_RENDER=100000;if(textDivs.length>MAX_TEXT_DIVS_TO_RENDER)return;for(var i=0,ii=textDivs.length;i<ii;i++){var textDiv=textDivs[i];if('isWhitespace'in textDiv.dataset){continue;}textLayerFrag.appendChild(textDiv);ctx.font=textDiv.style.fontSize+' '+textDiv.style.fontFamily;var width=ctx.measureText(textDiv.textContent).width;if(width>0){var textScale=textDiv.dataset.canvasWidth/width;var rotation=textDiv.dataset.angle;var transform='scale('+textScale+', 1)';transform='rotate('+rotation+'deg) '+transform;CustomStyle.setProp('transform',textDiv,transform);CustomStyle.setProp('transformOrigin',textDiv,'0% 0%');textLayerDiv.appendChild(textDiv);}}this.renderingDone=true;this.updateMatches();textLayerDiv.appendChild(textLayerFrag);};this.setupRenderLayoutTimer=function textLayerSetupRenderLayoutTimer(){var RENDER_DELAY=200;var self=this;var lastScroll=this.lastScrollSource===null?0:this.lastScrollSource.lastScroll;if(Date.now()-lastScroll>RENDER_DELAY){this.renderLayer();}else{if(this.renderTimer)clearTimeout(this.renderTimer);this.renderTimer=setTimeout(function(){self.setupRenderLayoutTimer();},RENDER_DELAY);}};this.appendText=function textLayerBuilderAppendText(geom){var textDiv=document.createElement('div');var fontHeight=geom.fontSize*Math.abs(geom.vScale);textDiv.dataset.canvasWidth=geom.canvasWidth*Math.abs(geom.hScale);textDiv.dataset.fontName=geom.fontName;textDiv.dataset.angle=geom.angle*(180/Math.PI);textDiv.style.fontSize=fontHeight+'px';textDiv.style.fontFamily=geom.fontFamily;textDiv.style.left=(geom.x+(fontHeight*Math.sin(geom.angle)))+'px';textDiv.style.top=(geom.y-(fontHeight*Math.cos(geom.angle)))+'px';this.textDivs.push(textDiv);};this.insertDivContent=function textLayerUpdateTextContent(){if(!this.layoutDone||this.divContentDone||!this.textContent)return;this.divContentDone=true;var textDivs=this.textDivs;var bidiTexts=this.textContent.bidiTexts;for(var i=0;i<bidiTexts.length;i++){var bidiText=bidiTexts[i];var textDiv=textDivs[i];if(!/\S/.test(bidiText.str)){textDiv.dataset.isWhitespace=true;continue;}textDiv.textContent=bidiText.str;textDiv.dir=bidiText.dir;}this.setupRenderLayoutTimer();};this.setTextContent=function textLayerBuilderSetTextContent(textContent){this.textContent=textContent;this.insertDivContent();};this.convertMatches=function textLayerBuilderConvertMatches(matches){var i=0;var iIndex=0;var bidiTexts=this.textContent.bidiTexts;var end=bidiTexts.length-1;var queryLen=PDFFindController===null?0:PDFFindController.state.query.length;var lastDivIdx=-1;var pos;var ret=[];for(var m=0;m<matches.length;m++){var matchIdx=matches[m];while(i!==end&&matchIdx>=(iIndex+bidiTexts[i].str.length)){iIndex+=bidiTexts[i].str.length;i++;}if(i==bidiTexts.length){console.error('Could not find matching mapping');}var match={begin:{divIdx:i,offset:matchIdx-iIndex}};matchIdx+=queryLen;while(i!==end&&matchIdx>(iIndex+bidiTexts[i].str.length)){iIndex+=bidiTexts[i].str.length;i++;}match.end={divIdx:i,offset:matchIdx-iIndex};ret.push(match);}return ret;};this.renderMatches=function textLayerBuilder_renderMatches(matches){if(matches.length===0){return;}var bidiTexts=this.textContent.bidiTexts;var textDivs=this.textDivs;var prevEnd=null;var isSelectedPage=PDFFindController===null?false:(this.pageIdx===PDFFindController.selected.pageIdx);var selectedMatchIdx=PDFFindController===null?-1:PDFFindController.selected.matchIdx;var highlightAll=PDFFindController===null?false:PDFFindController.state.highlightAll;var infty={divIdx:-1,offset:undefined};function beginText(begin,className){var divIdx=begin.divIdx;var div=textDivs[divIdx];div.textContent='';var content=bidiTexts[divIdx].str.substring(0,begin.offset);var node=document.createTextNode(content);if(className){var isSelected=isSelectedPage&&divIdx===selectedMatchIdx;var span=document.createElement('span');span.className=className+(isSelected?' selected':'');span.appendChild(node);div.appendChild(span);return;}div.appendChild(node);}function appendText(from,to,className){var divIdx=from.divIdx;var div=textDivs[divIdx];var content=bidiTexts[divIdx].str.substring(from.offset,to.offset);var node=document.createTextNode(content);if(className){var span=document.createElement('span');span.className=className;span.appendChild(node);div.appendChild(span);return;}div.appendChild(node);}function highlightDiv(divIdx,className){textDivs[divIdx].className=className;}var i0=selectedMatchIdx,i1=i0+1,i;if(highlightAll){i0=0;i1=matches.length;}else if(!isSelectedPage){return;}for(i=i0;i<i1;i++){var match=matches[i];var begin=match.begin;var end=match.end;var isSelected=isSelectedPage&&i===selectedMatchIdx;var highlightSuffix=(isSelected?' selected':'');if(isSelected&&!this.isViewerInPresentationMode){scrollIntoView(textDivs[begin.divIdx],{top:-50});}if(!prevEnd||begin.divIdx!==prevEnd.divIdx){if(prevEnd!==null){appendText(prevEnd,infty);}beginText(begin);}else{appendText(prevEnd,begin);}if(begin.divIdx===end.divIdx){appendText(begin,end,'highlight'+highlightSuffix);}else{appendText(begin,infty,'highlight begin'+highlightSuffix);for(var n=begin.divIdx+1;n<end.divIdx;n++){highlightDiv(n,'highlight middle'+highlightSuffix);}beginText(end,'highlight end'+highlightSuffix);}prevEnd=end;}if(prevEnd){appendText(prevEnd,infty);}};this.updateMatches=function textLayerUpdateMatches(){if(!this.renderingDone)return;var matches=this.matches;var textDivs=this.textDivs;var bidiTexts=this.textContent.bidiTexts;var clearedUntilDivIdx=-1;for(var i=0;i<matches.length;i++){var match=matches[i];var begin=Math.max(clearedUntilDivIdx,match.begin.divIdx);for(var n=begin;n<=match.end.divIdx;n++){var div=textDivs[n];div.textContent=bidiTexts[n].str;div.className='';}clearedUntilDivIdx=match.end.divIdx+1;}if(PDFFindController===null||!PDFFindController.active)return;this.matches=matches=this.convertMatches(PDFFindController===null?[]:(PDFFindController.pageMatches[this.pageIdx]||[]));this.renderMatches(this.matches);};};